<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de control - Gestionar Productores</title>
    <link rel="stylesheet" th:href="@{/css/panel.css}" />
    <link rel="stylesheet" th:href="@{/css/gestion_productores.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

</head>
<body class="panel-control">

<header class="Bienvenido">
    <div class="header-left">
        <img src="/img/logo.png" alt="Logo Agrosellnova" class="logo">
        <span class="project-name">AGROSELLNOVA</span>
    </div>

    <div class="header-right">
        <div class="user-info">
            <p><strong th:text="'Bienvenido, ' + ${usuario}">Bienvenido, Usuario</strong></p>
            <p><span th:text="'Rol: ' + ${rol}">Rol: Cliente</span></p>
        </div>
        <div class="icons">
            <a th:href="@{/notificaciones}" title="Notificaciones"><i class="fas fa-bell"></i></a>
            <a th:href="@{/private/perfil}" title="Perfil"><i class="fas fa-user-circle"></i></a>
        </div>
    </div>
</header>

<div class="panel-container">
    <aside class="sidebar">
        <div class="lateral-content">
            <ul>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/public/inicio}"><i class="fas fa-home"></i> Inicio</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/panel_control}"><i class="fas fa-person"></i> Mi informacion</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/reporte_ventas}"><i class="fas fa-chart-line"></i> Reporte de Ventas</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/reporte_reservas}"><i class="fas fa-calendar-check"></i> Reporte de Reservas</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/reporte_pqrs}"><i class="fas fa-envelope-open-text"></i> Reporte de PQRS</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/actualizar_roles}"><i class="fas fa-user-cog"></i> Actualizar Roles</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/gestionar_productores}"><i class="fas fa-tractor"></i> Gestionar Productores</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/usuarios_registrados}"><i class="fas fa-users"></i> Usuarios Registrados</a></li>
                <li th:if="${rol == 'administrador'}"><a th:href="@{/private/dashboard}"><i class ="fas fa-chart-line"></i> Reporte general</a></li>
                <li><a th:href="@{/public/cerrar_sesion}"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
            </ul>
        </div>
    </aside>
    <main class="panel-content">
        <h1>Gestión de Solicitudes de Productores</h1>
        <div class="estadisticas">
            <div class="estadistica-card">
                <div class="estadistica-numero" th:text="${cantidadPendientes ?: 0}">0</div>
                <div>Pendientes</div>
            </div>
            <div class="estadistica-card">
                <div class="estadistica-numero" th:text="${cantidadAprobados ?: 0}">0</div>
                <div>Aprobados</div>
            </div>
            <div class="estadistica-card">
                <div class="estadistica-numero" th:text="${cantidadRechazados ?: 0}">0</div>
                <div>Rechazados</div>
            </div>
        </div>
        <form th:action="@{/private/gestionar_productores}" method="get" class="filtro-form">
            <input type="text" name="buscar" th:value="${terminoBusqueda}" placeholder="Buscar por finca, ubicación o productos..." class="filtro-input">
            <select name="estado" class="filtro-select">
                <option value="">Todos los estados</option>
                <option value="Pendiente" th:selected="${estadoFiltro == 'Pendiente'}">Pendientes</option>
                <option value="Aprobado" th:selected="${estadoFiltro == 'Aprobado'}">Aprobados</option>
                <option value="Rechazado" th:selected="${estadoFiltro == 'Rechazado'}">Rechazados</option>
            </select>
            <button type="submit" class="filtro-btn">Filtrar</button>
            <a th:href="@{/private/gestionar_productores}" class="filtro-btn" style="background-color: #6c757d; text-decoration: none; display: inline-block; text-align: center;">
                Limpiar
            </a>
        </form>
        <table border="1">
            <thead>
            <tr>
                <th>Prioridad</th>
                <th>Finca</th>
                <th>Productor</th>
                <th>Ubicación</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Fecha Registro</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="productor, iterStat : ${productores}"
                th:class="${iterStat.index < 3 && productor.estadoSolicitud.name() == 'Pendiente'} ? 'prioridad-alta' :
                           (${iterStat.index < 6 && productor.estadoSolicitud.name() == 'Pendiente'} ? 'prioridad-media' : '')">
                <td style="text-align: center;">
                    <div th:if="${productor.estadoSolicitud.name() == 'Pendiente'}">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;" th:if="${iterStat.index < 3}"></i>
                        <i class="fas fa-clock" style="color: #ffc107;" th:if="${iterStat.index >= 3 && iterStat.index < 6}"></i>
                        <i class="fas fa-hourglass" style="color: #6c757d;" th:if="${iterStat.index >= 6}"></i>
                        <div class="antiguedad" th:text="${iterStat.index + 1} + '°'"></div>
                    </div>
                    <div th:unless="${productor.estadoSolicitud.name() == 'Pendiente'}">
                        <i class="fas fa-check" th:if="${productor.estadoSolicitud.name() == 'Aprobado'}" style="color: #28a745;"></i>
                        <i class="fas fa-times" th:if="${productor.estadoSolicitud.name() == 'Rechazado'}" style="color: #dc3545;"></i>
                    </div>
                </td>
                <td th:text="${productor.nombreFinca}">Finca Ejemplo</td>
                <td>
                    <span th:text="${productor.idUsuario}">ID Usuario</span>
                    <div class="antiguedad" th:text="'ID: ' + ${productor.idUsuario}"></div>
                </td>
                <td th:text="${productor.ubicacion}">Ubicación</td>
                <td th:text="${productor.tipoProduccion}">Tipo</td>
                <td>
                    <span class="estado-badge"
                          th:classappend="${productor.estadoSolicitud.name() == 'Pendiente'} ? 'estado-pendiente' :
                                         (${productor.estadoSolicitud.name() == 'Aprobado'} ? 'estado-aprobado' : 'estado-rechazado')"
                          th:text="${productor.estadoSolicitud}">Estado</span>
                </td>
                <td>
                    <span th:text="${#temporals.format(productor.fechaRegistro, 'dd/MM/yyyy')}">Fecha</span>
                    <div class="antiguedad" th:text="${#temporals.format(productor.fechaRegistro, 'HH:mm')}"></div>
                </td>
                <td>
                    <button class="btn-ver" onclick="abrirModal(this)"
                            th:data-id="${productor.idProductor}"
                            th:data-finca="${productor.nombreFinca}"
                            th:data-ubicacion="${productor.ubicacion}"
                            th:data-area="${productor.areaCultivo}"
                            th:data-tipo="${productor.tipoProduccion}"
                            th:data-experiencia="${productor.anosExperiencia}"
                            th:data-capacidad="${productor.capacidadProduccion}"
                            th:data-contacto="${productor.contactoComercial}"
                            th:data-productos="${productor.productos}"
                            th:data-descripcion="${productor.descripcion}"
                            th:data-estado="${productor.estadoSolicitud}"
                            th:data-fecha="${#temporals.format(productor.fechaRegistro, 'dd/MM/yyyy HH:mm')}"
                            th:data-usuario="${productor.idUsuario}">
                        Ver más
                    </button>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(productores)}">
                <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                    No se encontraron solicitudes de productores
                </td>
            </tr>
            </tbody>
        </table>
    </main>
</div>
<div id="modalProductor" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitulo">Detalles del Productor</h2>
        </div>
        <div class="modal-body">
            <div class="info-grid">
                <div class="info-item">
                    <strong>Nombre de la Finca:</strong><br>
                    <span id="modalFinca"></span>
                </div>
                <div class="info-item">
                    <strong>ID Usuario:</strong><br>
                    <span id="modalUsuario"></span>
                </div>
                <div class="info-item">
                    <strong>Ubicación:</strong><br>
                    <span id="modalUbicacion"></span>
                </div>
                <div class="info-item">
                    <strong>Área de Cultivo:</strong><br>
                    <span id="modalArea"></span> Ha
                </div>
                <div class="info-item">
                    <strong>Tipo de Producción:</strong><br>
                    <span id="modalTipo"></span>
                </div>
                <div class="info-item">
                    <strong>Años de Experiencia:</strong><br>
                    <span id="modalExperiencia"></span> años
                </div>
                <div class="info-item">
                    <strong>Capacidad de Producción:</strong><br>
                    <span id="modalCapacidad"></span> Ton/mes
                </div>
                <div class="info-item">
                    <strong>Estado de Solicitud:</strong><br>
                    <span id="modalEstado"></span>
                </div>
            </div>

            <div class="info-item" style="margin-bottom: 15px;">
                <strong>Contacto Comercial:</strong><br>
                <span id="modalContacto"></span>
            </div>

            <div class="info-item" style="margin-bottom: 15px;">
                <strong>Productos:</strong><br>
                <span id="modalProductos"></span>
            </div>

            <div class="info-item" style="margin-bottom: 15px;">
                <strong>Descripción:</strong><br>
                <span id="modalDescripcion"></span>
            </div>

            <div class="info-item">
                <strong>Fecha de Registro:</strong><br>
                <span id="modalFecha"></span>
            </div>
        </div>

        <div class="modal-actions" id="modalAcciones">
        </div>
    </div>
</div>

<script>
    let modal = document.getElementById("modalProductor");
    let span = document.getElementsByClassName("close")[0];
    let currentProductorId = null;
    function abrirModal(button) {
        currentProductorId = button.getAttribute('data-id');

        document.getElementById('modalFinca').textContent = button.getAttribute('data-finca');
        document.getElementById('modalUsuario').textContent = button.getAttribute('data-usuario');
        document.getElementById('modalUbicacion').textContent = button.getAttribute('data-ubicacion');
        document.getElementById('modalArea').textContent = button.getAttribute('data-area') || 'No especificado';
        document.getElementById('modalTipo').textContent = button.getAttribute('data-tipo');
        document.getElementById('modalExperiencia').textContent = button.getAttribute('data-experiencia') || 'No especificado';
        document.getElementById('modalCapacidad').textContent = button.getAttribute('data-capacidad') || 'No especificado';
        document.getElementById('modalContacto').textContent = button.getAttribute('data-contacto');
        document.getElementById('modalProductos').textContent = button.getAttribute('data-productos') || 'No especificado';
        document.getElementById('modalDescripcion').textContent = button.getAttribute('data-descripcion') || 'Sin descripción';
        document.getElementById('modalEstado').textContent = button.getAttribute('data-estado');
        document.getElementById('modalFecha').textContent = button.getAttribute('data-fecha');

        // Generar botones según el estado
        const estado = button.getAttribute('data-estado');
        const acciones = document.getElementById('modalAcciones');

        if (estado === 'Pendiente') {
            acciones.innerHTML = `
                <button class="btn-aprobar" onclick="aprobarProductor(${currentProductorId})">
                    <i class="fas fa-check"></i> Aprobar
                </button>
                <button class="btn-rechazar" onclick="rechazarProductor(${currentProductorId})">
                    <i class="fas fa-times"></i> Rechazar
                </button>
                <button class="btn-cerrar" onclick="cerrarModal()">Cerrar</button>
            `;
        } else {
            acciones.innerHTML = `
                <button class="btn-cerrar" onclick="cerrarModal()">Cerrar</button>
            `;
        }

        modal.style.display = "block";
    }
function aprobarProductor(id) {
    if (confirm('¿Estás seguro de que deseas aprobar esta solicitud?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/private/aprobar_productor/${id}`;

        const idUsuario = document.getElementById('modalUsuario').textContent;

        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = 'id_usuario';
        hiddenField.value = idUsuario;

        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
    }
}
    function rechazarProductor(id) {
        if (confirm('¿Estás seguro de que deseas rechazar esta solicitud?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/private/rechazar_productor/${id}`;
            document.body.appendChild(form);
            form.submit();
        }
    }
    function cerrarModal() {
        modal.style.display = "none";
    }
    span.onclick = function() {
        cerrarModal();
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            cerrarModal();
        }
    }
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            cerrarModal();
        }
    });
</script>

</body>
</html>